{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "AutomateLogListener"
        },
        "logAnalyticsWorkspaceID": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID to use when adding data to Log Analytics"
            }
        },
        "logAnalyticsSharedKey": {
            "type": "securestring",
            "metadata": {
                "description": "Primary key to use for authentication to Log Analytics"
            }
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "AutomateLog_cs": "dXNpbmcgU3lzdGVtLk5ldDsNCg0KcHVibGljIGNsYXNzIEF1dG9tYXRlTG9nIHsNCglwdWJsaWMgc3RyaW5nIF9fQ1VSU09SIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9fUkVBTFRJTUVfVElNRVNUQU1QIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9fTU9OT1RPTklDX1RJTUVTVEFNUCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfQk9PVF9JRCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfVFJBTlNQT1JUIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIFBSSU9SSVRZIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIFNZU0xPR19GQUNJTElUWSB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBTWVNMT0dfSURFTlRJRklFUiB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfUElEIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9VSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX0dJRCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfQ09NTSB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfRVhFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9DTURMSU5FIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9DQVBfRUZGRUNUSVZFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0NHUk9VUCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfU1lTVEVNRF9VTklUIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX1NMSUNFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0lOVk9DQVRJT05fSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX01BQ0hJTkVfSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX0hPU1ROQU1FIHsgZ2V0OyBzZXQ7IH0NCiAgICBwcml2YXRlIHN0cmluZyBfTUVTU0FHRV9zOw0KICAgIHB1YmxpYyBzdHJpbmcgTUVTU0FHRV9zIHsgZ2V0ew0KICAgICAgICByZXR1cm4gX01FU1NBR0VfczsgDQogICAgICAgIH0NCiAgICB9DQogICAgcHJpdmF0ZSBieXRlW10gX01FU1NBR0VfYjsNCglwdWJsaWMgYnl0ZVtdIE1FU1NBR0UgeyBzZXR7DQogICAgICAgIF9NRVNTQUdFX2IgPSB2YWx1ZTsNCiAgICAgICAgX01FU1NBR0VfcyA9IFN5c3RlbS5UZXh0LkVuY29kaW5nLlVURjguR2V0U3RyaW5nKHZhbHVlKTsNCiAgICAgICAgfQ0KICAgIH0gIA0KfQ==",
            "AutomateLog_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNsb2FkICJBdXRvbWF0ZUxvZy5jcyINCiNsb2FkICJBdXRvbWF0ZU1lc3NhZ2UuY3MiDQojbG9hZCAiQXV0b21hdGVMb2dQYXJzZXIuY3MiDQojbG9hZCAiTG9nQW5hbHl0aWNzV3JpdGVyLmNzIg0KI2xvYWQgIndvcmtzcGFjZS5jc3giDQp1c2luZyBTeXN0ZW0uTmV0Ow0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KcHVibGljIHN0YXRpYyBhc3luYyBUYXNrPEh0dHBSZXNwb25zZU1lc3NhZ2U+IFJ1bihIdHRwUmVxdWVzdE1lc3NhZ2UgcmVxLCBUcmFjZVdyaXRlciBsb2cpDQp7DQogICAgbG9nLkluZm8oIkMjIEhUVFAgdHJpZ2dlciBmdW5jdGlvbiBwcm9jZXNzZWQgYSByZXF1ZXN0LiIpOw0KDQoJLy8gR2V0IHJlcXVlc3QgYm9keQ0KCXZhciBib2R5ID0gYXdhaXQgcmVxLkNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKTsNCiAgICBzdHJpbmdbXSBsb2dzID0gYm9keS5TcGxpdCgnfScpOw0KDQogICAgTG9nQW5hbHl0aWNzV3JpdGVyIGxhdyA9IG5ldyBMb2dBbmFseXRpY3NXcml0ZXIoY3VzdG9tZXJJZCwgc2hhcmVkS2V5LCBsb2cpOw0KICAgIEF1dG9tYXRlTG9nIGRhdGEgPSBuZXcgQXV0b21hdGVMb2coKTsNCiAgICBmb3JlYWNoKHN0cmluZyBpdGVtIGluIGxvZ3Mpew0KICAgICAgICBzdHJpbmcgYXBwZW5kZWRJdGVtID0gaXRlbTsNCiAgICAgICAgaWYoIWFwcGVuZGVkSXRlbS5FbmRzV2l0aCgifSIpKXsNCiAgICAgICAgICAgIGFwcGVuZGVkSXRlbSA9IGFwcGVuZGVkSXRlbSArICd9JzsNCiAgICAgICAgfQ0KICAgICAgICBsb2cuSW5mbyhpdGVtKTsNCiAgICAgICAgaWYoaXRlbSAhPSBzdHJpbmcuRW1wdHkpew0KCSAgICAgICAgZGF0YSA9IEpzb25Db252ZXJ0LkRlc2VyaWFsaXplT2JqZWN0PEF1dG9tYXRlTG9nPihhcHBlbmRlZEl0ZW0gYXMgc3RyaW5nKTsNCiAgICAgICAgICAgIEF1dG9tYXRlTWVzc2FnZSBhdXRvbWF0ZU1lc3NhZ2UgPSBBdXRvbWF0ZUxvZ1BhcnNlci5QYXJzZUdlbmVyaWNMb2dNZXNzYWdlKGRhdGEuTUVTU0FHRV9zKTsNCiAgICAgICAgICAgIGxvZy5JbmZvKGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlKTsNCiAgICAgICAgICAgIGlmKGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlICE9ICJVbmtub3duIEVudHJ5Iil7DQogICAgICAgICAgICAgICAgc3RyaW5nIGxvZ05hbWUgPSBhdXRvbWF0ZU1lc3NhZ2Uuc291cmNlUGFja2FnZSArICJsb2ciOw0KICAgICAgICAgICAgICAgIGxhdy5TdWJtaXQoYXV0b21hdGVNZXNzYWdlLCBsb2dOYW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCglsb2cuSW5mbyhkYXRhLl9IT1NUTkFNRSk7DQoNCg0KICAgIHJldHVybiBkYXRhLk1FU1NBR0VfcyA9PSBudWxsDQogICAgICAgID8gcmVxLkNyZWF0ZVJlc3BvbnNlKEh0dHBTdGF0dXNDb2RlLkJhZFJlcXVlc3QsICJQbGVhc2UgcGFzcyBhIG5hbWUgb24gdGhlIHF1ZXJ5IHN0cmluZyBvciBpbiB0aGUgcmVxdWVzdCBib2R5IikNCiAgICAgICAgOiByZXEuQ3JlYXRlUmVzcG9uc2UoSHR0cFN0YXR1c0NvZGUuT0ssICJIZWxsbyAiICsgZGF0YS5NRVNTQUdFX3MpOw0KfQ0KDQo=",
            "AutomateLogParser_cs": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNsb2FkICJBdXRvbWF0ZU1lc3NhZ2UuY3MiDQp1c2luZyBTeXN0ZW0uTmV0Ow0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KdXNpbmcgU3lzdGVtLlRleHQuUmVndWxhckV4cHJlc3Npb25zOw0KdXNpbmcgU3lzdGVtLkdsb2JhbGl6YXRpb247DQoNCnB1YmxpYyBzdGF0aWMgY2xhc3MgQXV0b21hdGVMb2dQYXJzZXJ7DQogICAgcHVibGljIHN0YXRpYyBBdXRvbWF0ZU1lc3NhZ2UgUGFyc2VHZW5lcmljTG9nTWVzc2FnZShzdHJpbmcgbG9nTWVzc2FnZSwgVHJhY2VXcml0ZXIgbG9nKXsNCiAgICAgICAgaWYobG9nTWVzc2FnZS5Db250YWlucygiYXV0b21hdGUtbG9hZC1iYWxhbmNlciIpKXsNCiAgICAgICAgICAgIHJldHVybiBQYXJlc0F1dG9tYXRlTG9hZEJhbGFuY2VyTG9nKGxvZ01lc3NhZ2UsIGxvZyk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZXsNCiAgICAgICAgICAgIEF1dG9tYXRlTWVzc2FnZSBhdXRvbWF0ZU1lc3NhZ2UgPSBuZXcgQXV0b21hdGVNZXNzYWdlKCk7DQogICAgICAgICAgICBhdXRvbWF0ZU1lc3NhZ2Uuc291cmNlUGFja2FnZSA9ICJVbmtub3duIEVudHJ5IjsNCiAgICAgICAgICAgIHJldHVybiBhdXRvbWF0ZU1lc3NhZ2U7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIEF1dG9tYXRlTWVzc2FnZSBQYXJlc0F1dG9tYXRlTG9hZEJhbGFuY2VyTG9nKHN0cmluZyBsb2dNZXNzYWdlLCBUcmFjZVdyaXRlciBsb2cpew0KICAgICAgICBSZWdleCByeCA9IG5ldyBSZWdleChAIiguKikgXFsoLiopXF0gICIiKC4qKSIiIChcZCspICIiKC4qKSIiIChcZCspICIiKC4qKSIiICIiKC4qKSIiICIiKC4qKSIiICIiKC4qKSIiICIiKC4qKSIiIChcZCspIik7DQogICAgICAgIE1hdGNoIG0gPSByeC5NYXRjaChsb2dNZXNzYWdlKTsNCg0KICAgICAgICBDdWx0dXJlSW5mbyBwcm92aWRlciA9IEN1bHR1cmVJbmZvLkludmFyaWFudEN1bHR1cmU7DQoJCXN0cmluZyBkYXRlRm9ybWF0ID0gImRkL01NTS95eXl5OkhIOm1tOnNzICtmZmZmIjsgICAgICAgDQogICAgICAgIGxvZy5JbmZvKCI9PUQgQSBUIEUgVCBJIE0gRT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iKTsNCiAgICAgICAgbG9nLkluZm8obS5Hcm91cHNbMl0uVG9TdHJpbmcoKSk7DQogICAgICAgIGxvZy5JbmZvKCI9PUQgQSBUIEUgVCBJIE0gRT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iKTsNCg0KICAgICAgICBBdXRvbWF0ZU1lc3NhZ2UgYXV0b21hdGVNZXNzYWdlID0gbmV3IEF1dG9tYXRlTWVzc2FnZSgpOw0KICAgICAgICBhdXRvbWF0ZU1lc3NhZ2Uuc291cmNlUGFja2FnZSA9ICJhdXRvbWF0ZS1sb2FkLWJhbGFuY2VyIjsNCiAgICAgICAgYXV0b21hdGVNZXNzYWdlLnRpbWUgPSBEYXRlVGltZS5QYXJzZUV4YWN0KG0uR3JvdXBzWzJdLlRvU3RyaW5nKCksIGRhdGVGb3JtYXQsIEN1bHR1cmVJbmZvLkludmFyaWFudEN1bHR1cmUpOw0KICAgICAgICBhdXRvbWF0ZU1lc3NhZ2UubWVzc2FnZSA9IG0uR3JvdXBzWzNdLlRvU3RyaW5nKCk7DQogICAgICAgIGF1dG9tYXRlTWVzc2FnZS5zdGF0dXMgPSBtLkdyb3Vwc1s0XS5Ub1N0cmluZygpOw0KICAgICAgICByZXR1cm4gYXV0b21hdGVNZXNzYWdlOw0KICAgIH0NCn0NCg==",
            "AutomateMessage_cs": "dXNpbmcgU3lzdGVtLk5ldDsNCnVzaW5nIFN5c3RlbS5UZXh0LlJlZ3VsYXJFeHByZXNzaW9uczsNCg0KcHVibGljIGNsYXNzIEF1dG9tYXRlTWVzc2FnZXsNCiAgICBwdWJsaWMgc3RyaW5nIHNvdXJjZVBhY2thZ2UgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBzdHJpbmcgbG9nTGV2ZWwgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBEYXRlVGltZSB0aW1lIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIG1lc3NhZ2UgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBzdHJpbmcgam9iIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIGZ1bmN0aW9uIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIHN0YXR1cyB7IGdldDsgc2V0OyB9DQoNCiAgICBwdWJsaWMgc3RyaW5nIEdldExvZ0ZyaWVuZGx5UGFja2FnZU5hbWUoKXsNCiAgICAgICAgc3RyaW5nIHN0ciA9IHNvdXJjZVBhY2thZ2U7DQogICAgICAgIA0KICAgICAgICBSZWdleCByZ3ggPSBuZXcgUmVnZXgoIlteYS16QS1aMC05XSIpOw0KICAgICAgICBzdHIgPSByZ3guUmVwbGFjZShzdHIsICIiKSArICJsb2ciOw0KDQogICAgICAgIHJldHVybiBzdHI7DQogICAgfQ0KfQ0K",
            "LogAnalyticsWriter_cs": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCnVzaW5nIFN5c3RlbTsNCnVzaW5nIFN5c3RlbS5OZXQ7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHA7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHAuSGVhZGVyczsNCnVzaW5nIFN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHk7DQp1c2luZyBTeXN0ZW0uVGV4dDsNCnVzaW5nIFN5c3RlbS5UaHJlYWRpbmcuVGFza3M7DQp1c2luZyBOZXd0b25zb2Z0Lkpzb247DQoNCnB1YmxpYyBjbGFzcyBMb2dBbmFseXRpY3NXcml0ZXIgew0KICAgICAgICAvLyBVcGRhdGUgY3VzdG9tZXJJZCB0byB5b3VyIE9wZXJhdGlvbnMgTWFuYWdlbWVudCBTdWl0ZSB3b3Jrc3BhY2UgSUQNCiAgICAgICAgc3RyaW5nIEN1c3RvbWVySWQ7DQogICAgICAgIC8vIEZvciBzaGFyZWRLZXksIHVzZSBlaXRoZXIgdGhlIHByaW1hcnkgb3IgdGhlIHNlY29uZGFyeSBDb25uZWN0ZWQgU291cmNlcyBjbGllbnQgYXV0aGVudGljYXRpb24ga2V5ICAgDQogICAgICAgIHN0cmluZyBTaGFyZWRLZXk7DQogICAgICAgIFRyYWNlV3JpdGVyIEFGTG9nOw0KDQogICAgcHVibGljIExvZ0FuYWx5dGljc1dyaXRlcihzdHJpbmcgY3VzdG9tZXJJZCwgc3RyaW5nIHNoYXJlZEtleSwgVHJhY2VXcml0ZXIgbG9nKXsNCiAgICAgICAgQ3VzdG9tZXJJZCA9IGN1c3RvbWVySWQ7DQogICAgICAgIFNoYXJlZEtleSA9IHNoYXJlZEtleTsNCiAgICAgICAgQUZMb2cgPSBsb2c7DQogICAgICAgIEFGTG9nLkluZm8oQ3VzdG9tZXJJZCk7DQogICAgfQ0KDQogICAgLy8gQnVpbGQgdGhlIEFQSSBzaWduYXR1cmUNCiAgICBwcml2YXRlIHN0cmluZyBCdWlsZFNpZ25hdHVyZShzdHJpbmcgbWVzc2FnZSwgc3RyaW5nIHNlY3JldCkNCiAgICB7DQogICAgICAgIHZhciBlbmNvZGluZyA9IG5ldyBTeXN0ZW0uVGV4dC5BU0NJSUVuY29kaW5nKCk7DQogICAgICAgIGJ5dGVbXSBrZXlCeXRlID0gQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKHNlY3JldCk7DQogICAgICAgIGJ5dGVbXSBtZXNzYWdlQnl0ZXMgPSBlbmNvZGluZy5HZXRCeXRlcyhtZXNzYWdlKTsNCiAgICAgICAgdXNpbmcgKHZhciBobWFjc2hhMjU2ID0gbmV3IEhNQUNTSEEyNTYoa2V5Qnl0ZSkpDQogICAgICAgIHsNCiAgICAgICAgICAgIGJ5dGVbXSBoYXNoID0gaG1hY3NoYTI1Ni5Db21wdXRlSGFzaChtZXNzYWdlQnl0ZXMpOw0KICAgICAgICAgICAgQUZMb2cuSW5mbygiaW4gYnVpbGQgZnVuY3Rpb24gNSIpOw0KICAgICAgICAgICAgcmV0dXJuIENvbnZlcnQuVG9CYXNlNjRTdHJpbmcoaGFzaCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwcml2YXRlIHZvaWQgUG9zdERhdGEoc3RyaW5nIHNpZ25hdHVyZSwgc3RyaW5nIGpzb24sIHN0cmluZyBsb2dOYW1lLCBzdHJpbmcgZGF0ZSwgc3RyaW5nIHRpbWVzdGFtcCA9ICIiKQ0KICAgIHsgICAgICAgDQogICAgICAgIHRyeQ0KICAgICAgICB7DQogICAgICAgICAgICBzdHJpbmcgdXJsID0gImh0dHBzOi8vIiArIEN1c3RvbWVySWQgKyAiLm9kcy5vcGluc2lnaHRzLmF6dXJlLmNvbS9hcGkvbG9ncz9hcGktdmVyc2lvbj0yMDE2LTA0LTAxIjsNCiAgICAgICAgICAgIEFGTG9nLkluZm8odXJsKTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50IGNsaWVudCA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCgpOw0KICAgICAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7DQogICAgICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiTG9nLVR5cGUiLCBsb2dOYW1lKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJBdXRob3JpemF0aW9uIiwgc2lnbmF0dXJlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ4LW1zLWRhdGUiLCBkYXRlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ0aW1lLWdlbmVyYXRlZC1maWVsZCIsIHRpbWVzdGFtcCk7DQogICAgDQogICAgICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENvbnRlbnQgaHR0cENvbnRlbnQgPSBuZXcgU3RyaW5nQ29udGVudChqc29uLCBFbmNvZGluZy5VVEY4KTsNCiAgICAgICAgICAgIGh0dHBDb250ZW50LkhlYWRlcnMuQ29udGVudFR5cGUgPSBuZXcgTWVkaWFUeXBlSGVhZGVyVmFsdWUoImFwcGxpY2F0aW9uL2pzb24iKTsNCiAgICAgICAgICAgIFRhc2s8U3lzdGVtLk5ldC5IdHRwLkh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LlBvc3RBc3luYyhuZXcgVXJpKHVybCksIGh0dHBDb250ZW50KTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCByZXNwb25zZUNvbnRlbnQgPSByZXNwb25zZS5SZXN1bHQuQ29udGVudDsNCiAgICAgICAgICAgIHN0cmluZyByZXN1bHQgPSByZXNwb25zZUNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKS5SZXN1bHQ7DQogICAgICAgICAgICBBRkxvZy5JbmZvKCJSZXR1cm4gUmVzdWx0OiAiICsgcmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4Y2VwKQ0KICAgICAgICB7DQogICAgICAgICAgICBBRkxvZy5FcnJvcigiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCBTdWJtaXQoQXV0b21hdGVNZXNzYWdlIGF1dG9tYXRlTWVzc2FnZSwgc3RyaW5nIGxvZ05hbWUpew0KICAgICAgICB2YXIganNvbiA9IEpzb25Db252ZXJ0LlNlcmlhbGl6ZU9iamVjdChhdXRvbWF0ZU1lc3NhZ2UpOw0KDQogICAgICAgIHZhciBkYXRlc3RyaW5nID0gRGF0ZVRpbWUuVXRjTm93LlRvU3RyaW5nKCJyIik7DQogICAgICAgIHN0cmluZyBzdHJpbmdUb0hhc2ggPSAiUE9TVFxuIiArIGpzb24uTGVuZ3RoICsgIlxuYXBwbGljYXRpb24vanNvblxuIiArICJ4LW1zLWRhdGU6IiArIGRhdGVzdHJpbmcgKyAiXG4vYXBpL2xvZ3MiOw0KICAgICAgICBzdHJpbmcgaGFzaGVkU3RyaW5nID0gQnVpbGRTaWduYXR1cmUoc3RyaW5nVG9IYXNoLCBTaGFyZWRLZXkpOw0KICAgICAgICBzdHJpbmcgc2lnbmF0dXJlID0gIlNoYXJlZEtleSAiICsgQ3VzdG9tZXJJZCArICI6IiArIGhhc2hlZFN0cmluZzsNCg0KICAgICAgICBzdHJpbmcgdGltZXN0YW1wID0gYXV0b21hdGVNZXNzYWdlLnRpbWUuVG9TdHJpbmcoIllZWVktTU0tRERUaGg6bW06c3NaIik7DQogICAgICAgIEFGTG9nLkluZm8odGltZXN0YW1wKTsNCg0KICAgICAgICBBRkxvZy5JbmZvKCJzdWJtaXRpbmcgbG9nIik7DQogICAgICAgIFBvc3REYXRhKHNpZ25hdHVyZSwganNvbiwgbG9nTmFtZSwgZGF0ZXN0cmluZywgdGltZXN0YW1wKTsNCiAgICB9DQoNCn0="
        },
        "logAnalytics": {
            "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
            "shared_key": "[parameters('logAnalyticsSharedKey')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "authLevel": "function",
                            "name": "req",
                            "type": "httpTrigger",
                            "direction": "in",
                            "methods": [
                                "get",
                                "post"
                            ]
                        },
                        {
                            "name": "$return",
                            "type": "http",
                            "direction": "out"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "AutomateLog.cs": "[base64ToString(variables('code').AutomateLog_cs)]",
                    "AutomateLog.csx": "[base64ToString(variables('code').AutomateLog_csx)]",
                    "AutomateLogParser.cs": "[base64ToString(variables('code').AutomateLogParser_cs)]",
                    "AutomateMessage.cs": "[base64ToString(variables('code').AutomateMessage_cs)]",
                    "LogAnalyticsWriter.cs": "[base64ToString(variables('code').LogAnalyticsWriter_cs)]",
                    "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string shareKey = \"', variables('logAnalytics').shared_key, '\";')]"
                }
            }
        }
    ],
    "outputs": {
        "apiKey": {
            "type": "string",
            "value": "[listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key]"
        }
    }
}