{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "prefix": {
            "type": "string",
            "metadata": {
                "description": "Prefix to be applied to the name and hostname of the Chef and Automate servers"
            }
        },

        "customerResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of the resource group that contains the Virtual network to which the Chef and Automate servers should be connected to"
            }
        },

        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Virtual Network which contains the Subnet to which the machines should be connected"
            }
        },

        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the subnet to which the machines should be connected to"
            }
        },

        "uniqueShort": {
            "type": "string",
            "metadata": {
                "description": "A string of 4 or 5 characters that will be used to help uniquely identify the resources that are created. If this is not specified then a value will be automatically created."
            },
            "defaultValue": ""
        },

        "networkVNetSize": {
            "type": "string",
            "defaultValue": "10.0.0.0/24"
        },
    
        "networkSubnetSize": {
            "type": "string",
            "defaultValue": "10.0.0.0/28"
        }
    },
    "variables": {
        "unique": "[uniqueString(subscription().subscriptionId, resourceGroup().id, deployment().name, parameters('prefix'))]",
        "uniqueShort": "[if(empty(parameters('uniqueShort')), substring(variables('unique'), 0, 4), parameters('uniqueShort'))]",

        "baseUrl": "https://raw.githubusercontent.com/chef-partners/azure-managed-automate/master",

        "location": "[resourceGroup().location]",

        "name": {
            "virtualNetwork": "[concat(parameters('prefix'), '-', variables('uniqueShort'), '-VNet')]",
            "subnet":  "[concat(parameters('prefix'), '-', variables('uniqueShort'), '-Subnet')]",
            "vm": {
                "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'), '-VM')]",
                "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'), '-VM')]"
            },
            "computer": {
                "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'))]",
                "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'))]"
            },
            "publicIPAddress": {
                "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'), '-PublicIP')]",
                "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'), '-PublicIP')]"
            },
            "nic": {
                "ama": {
                    "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'), '-AMA-NIC')]",
                    "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'), '-AMA-NIC')]"
                },
                "customer": {
                    "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'), '-Customer-VNet-NIC')]",
                    "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'), '-Customer-VNet-NIC')]"
                }
            },
            "nsg": {
                "chef": "[concat(parameters('prefix'), '-chef-', variables('uniqueShort'), '-Customer-NSG')]",
                "automate": "[concat(parameters('prefix'), '-automate-', variables('uniqueShort'), '-Customer-NSG')]"
            }
        },

        "networks": {
            "vnet": "[parameters('networkVNetSize')]",
            "subnet": "[parameters('networkSubnetSize')]"
        },

        "customerVNetID": "[resourceId(parameters('customerResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "customerSubnetRef": "[concat(variables('customerVNetID'), '/subnets/', parameters('subnetName'))]",

        "urls": {
            "virtualNetwork": "[concat(variables('baseUrl'), '/src/templates/virtual-network.json')]",
            "publicIPAddress": "[concat(variables('baseUrl'), '/src/templates/public-ipaddress.json')]",
            "networkInterfacePrivate": "[concat(variables('baseUrl'), '/src/templates/network-interface-private.json')]",
            "networkInterfacePublic": "[concat(variables('baseUrl'), '/src/templates/network-interface-public.json')]",
            "networkSecurityGroup": "[concat(variables('baseUrl'), '/src/templates/network-security-group.json')]"
        },

        "apiVersions": {
            "deployments": "2016-02-01"
        }
    },
    "resources": [

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').virtualNetwork, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').virtualNetwork]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetworkName": {
                      "value": "[variables('name').virtualNetwork]"
                    },
                    "location": {
                      "value": "[variables('location')]"
                    },
                    "vnetAddressPrefix": {
                      "value": "[variables('networks').vnet]"
                    },
                    "subnetName": {
                      "value": "[variables('name').subnet]"
                    },
                    "subnetPrefix": {
                      "value": "[variables('networks').subnet]"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nsg.chef, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "properties": {
                "mode":"Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkSecurityGroup]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "groupName": {
                        "value": "variables('name').nsg.chef"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nsg.automate, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "properties": {
                "mode":"Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkSecurityGroup]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "groupName": {
                        "value": "variables('name').nsg.automate"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').publicIPAddress.chef, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').publicIPAddress]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "publicIPAddressName": {
                        "value": "[variables('name').publicIPAddress.chef]"
                    },
                    "publicIPAddressType": {
                        "value": "Dynamic"
                    },
                    "dnsLabelPrefix": {
                        "value": "[variables('name').computer.chef]"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').publicIPAddress.automate, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').publicIPAddress]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "publicIPAddressName": {
                        "value": "[variables('name').publicIPAddress.automate]"
                    },
                    "publicIPAddressType": {
                        "value": "Dynamic"
                    },
                    "dnsLabelPrefix": {
                        "value": "[variables('name').computer.automate]"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nic.ama.chef, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('name').virtualNetwork, '-Deployment')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkInterfacePrivate]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "nicName": {
                        "value": "[variables('name').nic.ama.chef]"
                    },
                    "subnetRef": {
                        "value": "[reference(concat(variables('name').virtualNetwork, '-Deployment')).outputs.subnetRef.value]"
                    }
                }
            }
        },

        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nic.ama.automate, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('name').virtualNetwork, '-Deployment')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkInterfacePrivate]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "nicName": {
                        "value": "[variables('name').nic.ama.automate]"
                    },
                    "subnetRef": {
                        "value": "[reference(concat(variables('name').virtualNetwork, '-Deployment')).outputs.subnetRef.value]"
                    }
                }
            }
        },
        
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nic.customer.chef, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('name').publicIPAddress.chef, '-Deployment')]",
                "[concat('Microsoft.Resources/deployments/', variables('name').nsg.chef, '-Deployment')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkInterfacePublic]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "nicName": {
                        "value": "[variables('name').nic.customer.chef]"
                    },
                    "publicIPAddressRef": {
                        "value": "[reference(concat(variables('name').publicIPAddress.chef, '-Deployment')).outputs.publicIpId.value]"
                    },
                    "subnetRef": {
                        "value": "[variables('customerSubnetRef')]"
                    },
                    "nsgRef": {
                        "value": "[reference(concat(variables('name').nsg.chef, '-Deployment')).outputs.nsgId.value]"
                    }
                }
            }
        },
        
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat(variables('name').nic.customer.automate, '-Deployment')]",
            "apiVersion": "[variables('apiVersions').deployments]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('name').publicIPAddress.automate, '-Deployment')]",
                "[concat('Microsoft.Resources/deployments/', variables('name').nsg.automate, '-Deployment')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('urls').networkInterfacePublic]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "nicName": {
                        "value": "[variables('name').nic.customer.automate]"
                    },
                    "publicIPAddressRef": {
                        "value": "[reference(concat(variables('name').publicIPAddress.automate, '-Deployment')).outputs.publicIpId.value]"
                    },
                    "subnetRef": {
                        "value": "[variables('customerSubnetRef')]"
                    },
                    "nsgRef": {
                        "value": "[reference(concat(variables('name').nsg.automate, '-Deployment')).outputs.nsgId.value]"
                    }
                }
            }
        }        
    ],
    "outputs": {
        
    }
}